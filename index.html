<script>
  const users = JSON.parse(localStorage.getItem("users")) || {};
  let currentUser = null;

  function register() {
    const user = document.getElementById('username').value.trim();
    const pass = document.getElementById('password').value;

    if (user.length < 3 || user.length > 30) {
      alert("Username must be between 3 and 30 characters.");
      return;
    }

    if (pass.length < 8) {
      alert("Password must be at least 8 characters.");
      return;
    }

    if (users[user]) {
      alert("Username already exists.");
    } else {
      users[user] = { password: pass, profilePic: "" };
      localStorage.setItem("users", JSON.stringify(users));
      alert("Registered successfully.");
    }
  }

  function login() {
    const user = document.getElementById('username').value.trim();
    const pass = document.getElementById('password').value;

    if (!users[user]) {
      alert("Username not found.");
      return;
    }

    if (users[user].password !== pass) {
      alert("Incorrect password.");
      return;
    }

    currentUser = user;
    localStorage.setItem("currentUser", currentUser);
    showChat();
  }

  function showChat() {
    document.getElementById('auth').style.display = 'none';
    document.getElementById('chat').style.display = 'block';
    document.getElementById('userDisplay').textContent = currentUser;
    document.getElementById('profilePic').src = users[currentUser].profilePic || '';
  }

  function logout() {
    currentUser = null;
    localStorage.removeItem("currentUser");
    document.getElementById('chat').style.display = 'none';
    document.getElementById('auth').style.display = 'block';
    document.getElementById('messages').innerHTML = '';
  }

  function sendMessage() {
    const input = document.getElementById('messageInput');
    const msg = input.value.trim();
    if (msg === '') return;

    const messages = document.getElementById('messages');
    const newMsg = document.createElement('div');
    newMsg.className = 'msg';
    newMsg.textContent = `${currentUser}: ${msg}`;
    messages.appendChild(newMsg);

    input.value = '';
    messages.scrollTop = messages.scrollHeight;
  }

  function showProfileEditor() {
    document.getElementById('chat').style.display = 'none';
    document.getElementById('profileEdit').style.display = 'block';
    document.getElementById('newUsername').value = currentUser;
  }

  function cancelEdit() {
    document.getElementById('profileEdit').style.display = 'none';
    document.getElementById('chat').style.display = 'block';
  }

  function updateProfile() {
    const newUser = document.getElementById('newUsername').value.trim();
    const newPass = document.getElementById('newPassword').value;
    const newPicInput = document.getElementById('newProfilePic');
    const reader = new FileReader();

    if (newUser.length < 3 || newUser.length > 30) {
      alert("New username must be between 3 and 30 characters.");
      return;
    }

    if (newPass.length < 8) {
      alert("New password must be at least 8 characters.");
      return;
    }

    if (newUser !== currentUser && users[newUser]) {
      alert("Username already taken.");
      return;
    }

    const applyUpdate = (base64Pic) => {
      delete users[currentUser];
      users[newUser] = {
        password: newPass,
        profilePic: base64Pic || users[currentUser].profilePic
      };
      currentUser = newUser;
      localStorage.setItem("users", JSON.stringify(users));
      localStorage.setItem("currentUser", currentUser);
      document.getElementById('userDisplay').textContent = currentUser;
      document.getElementById('profilePic').src = users[currentUser].profilePic;
      document.getElementById('profileEdit').style.display = 'none';
      document.getElementById('chat').style.display = 'block';
      alert("Profile updated successfully.");
    };

    if (newPicInput.files.length > 0) {
      reader.onload = () => applyUpdate(reader.result);
      reader.readAsDataURL(newPicInput.files[0]);
    } else {
      applyUpdate();
    }
  }

  // Enter to send, Shift+Enter for newline
  document.getElementById('messageInput').addEventListener('keydown', function(e) {
    if (e.key === 'Enter' && !e.shiftKey) {
      e.preventDefault();
      sendMessage();
    }
  });

  // Auto-login if saved
  const savedUser = localStorage.getItem("currentUser");
  if (savedUser && users[savedUser]) {
    currentUser = savedUser;
    showChat();
  } else {
    document.getElementById('auth').style.display = 'block';
  }
</script>
